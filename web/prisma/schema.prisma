datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========================================
// NextAuth Required Models
// ========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========================================
// App Models
// ========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  githubId      String?   @unique
  username      String?
  createdAt     DateTime  @default(now())

  accounts      Account[]
  sessions      Session[]
  apiKeys       ApiKeys?
  projects      Project[]
  designSystems DesignSystem[]
}

model ApiKeys {
  id               String   @id @default(cuid())
  userId           String   @unique
  githubTokenEnc   String   @db.Text
  githubTokenHint  String?
  claudeApiKeyEnc  String?  @db.Text
  claudeApiKeyHint String?
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Project {
  id               String   @id @default(cuid())
  userId           String
  name             String
  githubRepo       String
  githubBranch     String   @default("main")
  githubFilePath   String   @default("tokens.json")
  syncMode         String   @default("single")
  pushMode         String   @default("direct")
  fileMapping      Json?
  defaultDirectory String   @default("tokens/")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Figma variable snapshot (pushed by plugin)
  figmaSnapshot   Json?
  figmaSnapshotAt DateTime?
  figmaFileName   String?

  // Plugin status tracking (heartbeat)
  pluginLastSeen      DateTime?
  pluginFigmaFileName String?
  pluginProjectId     String?

  // Design System (embedded, optional â€” at most one per project)
  designSystemName   String?
  designSystemSource String?  // "scratch" | "figma-import" | "ai-generated" | null
  designSystemDomain String?  // tech | healthcare | finance | education | ecommerce | creative | enterprise
  themeConfig        Json?    // { accentColor, grayColor, paletteMode, radius, scaling, appearance }
  typographyConfig   Json?    // { fontFamily, headingFont, baseSize, scale, weights }
  spacingConfig      Json?    // { baseUnit, scale }
  componentConfig    Json?    // { selectedComponents: string[] }
  tokensDocument     Json?    // Full generated DTCG token document
  documentation      Json?    // Auto-generated docs

  // AI-generation context (populated by /create onboarding flow)
  productDescription  String?
  productDomain       String?   // AI-detected: "fintech", "project-management", etc.
  productVibe         String?   // "clean-minimal" | "professional-trustworthy" | etc.
  brandReferences     String?
  designPhilosophy    String?   @db.Text
  designPrinciples    Json?     // string[]
  layoutConfig        Json?     // { suggestedLayouts, navigationStyle, contentDensity }
  version             Int       @default(1)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NOTE: DesignSystem model kept temporarily for migration.
// Existing data will not be migrated (only test records).
// Remove in a future cleanup PR.
model DesignSystem {
  id               String   @id @default(cuid())
  userId           String
  name             String
  domain           String
  companyName      String?
  productName      String?
  colorConfig      Json
  typographyConfig Json
  spacingConfig    Json
  radiusConfig     Json
  shadowConfig     Json
  componentConfig  Json
  tokensDocument   Json?
  documentation    Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
